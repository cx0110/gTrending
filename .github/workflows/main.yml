name: Daily Trending Scraper

on:
  schedule:
    - cron: '0 17 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  run-scraper:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # å¿…é¡»å¼€å¯å†™å…¥æƒé™

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run Scraper
        env:
          # åœ¨ GitHub Secrets ä¸­é…ç½®è¿™äº›å˜é‡
          # è®¾ä¸º 'true' å¯ç”¨ LangChainï¼Œè®¾ä¸º 'false' ä»…æŠ“å–
          TZ: 'Asia/Shanghai'
          ENABLE_LLM: ${{ vars.ENABLE_LLM || 'false' }} 
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          # å¦‚æœä½¿ç”¨ç¬¬ä¸‰æ–¹/ä»£ç†ï¼Œè¯·é…ç½® BASE_URLï¼Œå¦åˆ™é»˜è®¤å®˜æ–¹
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
        run: python main.py

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # æš‚å­˜æ‰€æœ‰æ›´æ”¹ (åŒ…æ‹¬ archives/ å’Œ data/history.json å’Œ README.md)
          git add .
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŠ¨
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "bot: update trending for $(date +'%Y-%m-%d')"
            git push
          fi
      # === æ–°å¢æ­¥éª¤ï¼šæ¨é€åˆ° Obsidian ä»“åº“ (Repo B) ===
      - name: Push to Obsidian Vault
        uses: cpina/github-action-push-to-another-repository@main
        env:
          TZ: 'Asia/Shanghai'
          # è®°å¾—åœ¨ Repo A çš„ Secrets é‡Œé…ç½® API_TOKEN_GITHUB
          API_TOKEN_GITHUB: ${{ secrets.API_TOKEN_GITHUB }}
        with:
          # æ¥æºï¼šä½ çš„ Python è„šæœ¬ç”Ÿæˆçš„æ–‡ä»¶å¤¹å (configä¸­ settings['archive_dir'] çš„å€¼)
          # é»˜è®¤ä¸º archives/ï¼Œå¦‚æœä½ æ²¡æ”¹ config.yaml å°±æ˜¯è¿™ä¸ª
          source-directory: 'archives/'
          
          # ç›®æ ‡ï¼šä½ çš„ GitHub ç”¨æˆ·å
          destination-github-username: 'cx0110'
          
          # ç›®æ ‡ï¼šä½ çš„ Obsidian ä»“åº“å
          destination-repository-name: 'ob-note'
          
          # ä½ çš„é‚®ç®±
          user-email: 'github.cx0110@gmail.com'
          
          # ç›®æ ‡åˆ†æ”¯ (é€šå¸¸æ˜¯ main æˆ– master)
          target-branch: main
          
          # ã€å…³é”®ã€‘ç›®æ ‡è·¯å¾„ï¼šç¬¦åˆä½ çš„ PARA ç»“æ„
          # è­¦å‘Šï¼šè¿™ä¸ªæ–‡ä»¶å¤¹å†…çš„æ—§å†…å®¹ä¼šè¢« source-directory çš„å†…å®¹å®Œå…¨è¦†ç›–/åŒæ­¥
          # æ‰€ä»¥å¿…é¡»æŒ‡å®šä¸€ä¸ªä¸“å±çš„å­æ–‡ä»¶å¤¹ï¼Œä¸è¦ç›´æ¥å¡« 00_Inboxï¼Œå¦åˆ™ Inbox å…¶ä»–æ–‡ä»¶ä¼šè¢«åˆ ï¼
          target-directory: '90_Archives/Tech_News/Github'
          # === ä¿®æ”¹éƒ¨åˆ†ï¼šæ¨é€åˆ°åšå®¢ (åˆ›å»ºæ¨¡å¼) ===
      - name: Create Post in Hugo Blog
        env:
          BLOG_REPO_TOKEN: ${{ secrets.API_TOKEN_GITHUB }}
          BLOG_REPO: ${{ vars.BLOG_REPO }}
        run: |
          TODAY=$(date +'%Y-%m-%d')
          # è®¾å®šç»Ÿä¸€çš„æ–‡ä»¶å¤¹åç§°ï¼ŒRepo B ä¹Ÿè¦ç”¨è¿™ä¸ª
          POST_DIR="content/post/${TODAY}-daily-news"
          
          # 1. Clone åšå®¢ä»“åº“
          git clone --depth 1 https://x-access-token:${BLOG_REPO_TOKEN}@github.com/${BLOG_REPO}.git blog
          
          # 2. åˆ›å»ºç›®å½•
          mkdir -p "blog/${POST_DIR}"
          TARGET_FILE="blog/${POST_DIR}/index.md"
          
          # 3. å†™å…¥ Front Matter (è¦†ç›–æ¨¡å¼ï¼Œå› ä¸ºå®ƒæ˜¯ç¬¬ä¸€ä¸ªè¿è¡Œçš„)
          cat > "$TARGET_FILE" << EOF
          ---
          title: "ğŸ”¥ æ¯æ—¥æŠ€æœ¯çƒ­ç‚¹ ${TODAY}"
          subtitle: "GitHub Trending & æŠ€æœ¯åŠ¨æ€"
          summary: "ä»Šæ—¥çƒ­é—¨å¼€æºé¡¹ç›®ä¸æŠ€æœ¯èµ„è®¯æ±‡æ€»"
          authors:
            - admin
          tags:
            - GitHub
            - Trending
            - æŠ€æœ¯çƒ­ç‚¹
          categories:
            - æ¯æ—¥çƒ­ç‚¹
          date: ${TODAY}T09:00:00+08:00
          lastmod: ${TODAY}T09:00:00+08:00
          featured: false
          draft: false
          image:
            filename: github-logo.svg
            focal_point: Smart
            preview_only: false
          ---
          
          ## ğŸ“ˆ GitHub Trending
          
          EOF
          
          # 4. è¿½åŠ  Repo A çš„å†…å®¹ (å»æ‰ç¬¬ä¸€è¡Œæ ‡é¢˜ï¼Œé˜²æ­¢é‡å¤)
          if [ -f "archives/${TODAY}.md" ]; then
            sed '1{/^#/d;}' "archives/${TODAY}.md" >> "$TARGET_FILE"
          else
            sed '1{/^#/d;}' README.md >> "$TARGET_FILE"
          fi
          
          # 5. æ¨é€
          cd blog
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          
          if git diff --staged --quiet; then
            echo "No changes"
          else
            git commit -m "ğŸ“° Create Daily: ${TODAY}"
            git push
          fi
