name: Weekly Trending Scraper

on:
  schedule:
    # æ¯å‘¨ä¸€ UTC 02:00 (åŒ—äº¬æ—¶é—´ 10:00) è¿è¡Œ
    # é¿å¼€æ—¥æŠ¥çš„è¿è¡Œæ—¶é—´
    - cron: '0 2 * * 1'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  run-weekly-scraper:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run Scraper (Weekly Mode)
        env:
          # === å…³é”®ï¼šå¼€å¯ Weekly æ¨¡å¼ ===
          SCRAPE_MODE: weekly 
          ENABLE_LLM: ${{ vars.ENABLE_LLM || 'false' }} 
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
        run: python main.py

      - name: Commit and Push (Save to Repo)
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # åªè¦æ·»åŠ  weekly_archives ç›®å½•
          git add weekly_archives/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "bot: update weekly trending for $(date +'%Y-%m-%d')"
            git push
          fi

      # === æ¨é€åˆ° Obsidian (Weekly æ–‡ä»¶å¤¹) ===
      - name: Push to Obsidian Vault
        uses: cpina/github-action-push-to-another-repository@main
        env:
          API_TOKEN_GITHUB: ${{ secrets.API_TOKEN_GITHUB }}
        with:
          # æ¥æºï¼šmain.py ä¸­ä¿®æ”¹åçš„ç›®å½•
          source-directory: 'weekly_archives/'
          
          destination-github-username: 'cx0110'
          destination-repository-name: 'ob-note'
          user-email: 'github.cx0110@gmail.com'
          target-branch: main
          
          # ç›®æ ‡ï¼šä¸“é—¨çš„ Weekly ç›®å½•
          target-directory: '90_Archives/Tech_News/Github_Weekly'

      # === æ¨é€åˆ° Hugo Blog (æ¯å‘¨çƒ­ç‚¹) ===
      - name: Create Weekly Post in Hugo Blog
        env:
          BLOG_REPO_TOKEN: ${{ secrets.API_TOKEN_GITHUB }}
          BLOG_REPO: ${{ vars.BLOG_REPO }}
        run: |
          TODAY=$(date +'%Y-%m-%d')
          # æ–‡ä»¶å¤¹ååŠ ä¸Š weekly åŒºåˆ†
          POST_DIR="content/post/${TODAY}-weekly-news"
          
          git clone --depth 1 https://x-access-token:${BLOG_REPO_TOKEN}@github.com/${BLOG_REPO}.git blog
          
          mkdir -p "blog/${POST_DIR}"
          TARGET_FILE="blog/${POST_DIR}/index.md"
          
          # å†™å…¥ Weekly çš„ Front Matter
          cat > "$TARGET_FILE" << EOF
          ---
          title: "ğŸ—“ï¸ æ¯å‘¨æŠ€æœ¯çƒ­ç‚¹ ${TODAY}"
          subtitle: "GitHub Weekly Trending"
          summary: "æœ¬å‘¨ GitHub æœ€çƒ­é—¨çš„å¼€æºé¡¹ç›®æ±‡æ€»"
          authors:
            - admin
          tags:
            - GitHub
            - Weekly
            - æŠ€æœ¯çƒ­ç‚¹
          categories:
            - æ¯å‘¨çƒ­ç‚¹
          date: ${TODAY}T10:00:00+08:00
          lastmod: ${TODAY}T10:00:00+08:00
          featured: true
          draft: false
          image:
            caption: "Weekly Review"
            focal_point: "Smart"
          ---
          
          ## ğŸ† æœ¬å‘¨çƒ­é—¨é¡¹ç›®
          
          EOF
          
          # è¿½åŠ å†…å®¹ (è¯»å– weekly_archives ä¸‹çš„æ–‡ä»¶)
          if [ -f "weekly_archives/${TODAY}.md" ]; then
            sed '1{/^#/d;}' "weekly_archives/${TODAY}.md" >> "$TARGET_FILE"
          else
            echo "æš‚æ— æ•°æ®" >> "$TARGET_FILE"
          fi
          
          # æ¨é€
          cd blog
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          
          if git diff --staged --quiet; then
            echo "No changes"
          else
            git commit -m "ğŸ“… Create Weekly: ${TODAY}"
            git push
          fi
